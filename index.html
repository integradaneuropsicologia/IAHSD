<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Inventário de Altas Habilidades</title>
<style>
  :root{
    --bg:#0e1625; --card:#14213b; --line:#2b3f66;
    --text:#f8fafc; --muted:#cbd5e1;
    --pri:#6d28d9; --ok:#10b981; --err:#ef4444; --warn:#f59e0b;
    --chip:#0b1220; --chipHover:#0f1a2e; --chipSel:#1e293b;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;background:var(--bg);color:var(--text);
    font:16px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  }
  .wrap{max-width:1024px;margin:20px auto;padding:0 16px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:18px}
  h1{margin:0 0 6px;font-size:1.45rem}
  .muted{color:var(--muted)}

  .grid-info{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin:12px 0 6px}
  @media (max-width:720px){.grid-info{grid-template-columns:1fr}}
  .info{background:rgba(0,0,0,.18);border:1px solid var(--line);border-radius:12px;padding:12px}
  .info b{display:block;margin-bottom:4px;color:#e2e8f0}

  .section{margin:18px 0 8px;padding:10px 12px;border:1px solid var(--line);border-radius:12px;background:rgba(0,0,0,.18);font-weight:700}

  /* ===== ITENS ===== */
  .item{border:1px solid var(--line);border-radius:12px;padding:12px;background:rgba(0,0,0,.18);margin-bottom:12px}
  .stem{font-size:1rem;margin-bottom:10px}
  .scale{display:grid;grid-template-columns:repeat(5,minmax(140px,1fr));gap:10px}
  @media (max-width:680px){ .scale{grid-template-columns:1fr} }

  /* Botões de escolha (1..5) */
  .opt{
    display:flex;align-items:center;gap:10px; padding:10px 12px;
    border:1px solid var(--line); border-radius:12px; background:var(--chip);
    cursor:pointer; transition:background .15s ease, border-color .15s ease, transform .05s ease;
  }
  .opt:hover{background:var(--chipHover); border-color:#4f70ff; transform:translateY(-1px)}
  .opt input{appearance:none;-webkit-appearance:none; width:0;height:0;position:absolute;opacity:0}
  .opt span{font-weight:700}
  .opt small{opacity:.8}
  .opt:has(input:checked){background:var(--chipSel); border-color:#6d28d9; box-shadow:0 0 0 1px #6d28d9 inset}

  .legend{display:flex;flex-wrap:wrap;gap:8px;margin:6px 0 12px}
  .pill{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid var(--line);background:rgba(0,0,0,.25);font-size:.86rem}

  /* Ações */
  .btn{display:inline-flex;align-items:center;gap:10px;background:var(--pri);border:none;color:#fff;padding:12px 16px;border-radius:12px;cursor:pointer;font-weight:600}
  .btn.ok{background:var(--ok)}
  .btn.ghost{background:transparent;border:1px solid var(--line);color:#cbd5e1}
  .btn:disabled{opacity:.6;cursor:not-allowed}

  /* Mensagens */
  .msg{margin:12px 0;padding:12px;border-radius:10px}
  .okbox{background:#06351f;border:1px solid #0e6c45;color:#c8ffe3}
  .errbox{background:#3b0d0d;border:1px solid #7f1d1d;color:#ffd5d5}
  .warnbox{background:#3a2903;border:1px solid #885e09;color:#ffe6b0}

  /* Progresso */
  .progress{height:10px;background:rgba(255,255,255,.05);border:1px solid var(--line);border-radius:999px;overflow:hidden}
  .bar{height:100%;width:0%;background:linear-gradient(90deg, #6d28d9, #10b981)}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Inventário de Altas Habilidades</h1>
    <p class="muted">
      Assinale o quanto você concorda com cada afirmação. Opções:
      <b>DT</b>=Discordo totalmente (1), <b>D</b>=Discordo (2),
      <b>N</b>=Nem discordo nem concordo (3), <b>C</b>=Concordo (4),
      <b>CT</b>=Concordo totalmente (5).
    </p>

    <div class="legend">
      <span class="pill">Dimensão 1: Habilidades Cognitivas</span>
      <span class="pill">Dimensão 2: Habilidades Criativas</span>
      <span class="pill">Dimensão 3: Motivação e Determinação</span>
      <span class="pill">Dimensão 4: Habilidades Sociais e de Liderança</span>
      <span class="pill">Dimensão 5: Sensibilidade e Autoconsciência</span>
    </div>

    <div id="pacInfo" class="grid-info" style="display:none;"></div>

    <div id="progressWrap" style="display:none; gap:8px; align-items:center; margin:8px 0 0;">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:6px">
        <span class="muted" id="progressText">Progresso: 0/50</span>
        <button id="clearDraft" class="btn ghost" type="button" title="Limpar rascunho local">Limpar rascunho</button>
      </div>
      <div class="progress"><div class="bar" id="bar"></div></div>
    </div>

    <form id="form" style="margin-top:14px; display:none;" novalidate>
      <div id="qs"></div>
      <div style="margin-top:14px;display:flex;gap:10px;flex-wrap:wrap">
        <button id="btnSubmit" class="btn ok" type="submit">Enviar respostas</button>
        <button id="btnSave" class="btn ghost" type="button" title="Salvar rascunho">Salvar rascunho</button>
      </div>
      <div id="msg" class="msg" style="display:none" role="alert" aria-live="polite"></div>
    </form>

    <div id="alert" class="msg" style="display:none" role="alert" aria-live="assertive"></div>
  </div>
</div>

<script>
/* ===== CONFIG ===== */
const SHEETDB_BASE = "https://sheetdb.io/api/v1/8pmdh33s9fvy8";
const SHEETS = { PATIENTS:"Patients", TOKENS:"LinkTokens", SCORES:"Scores_IAHSD" }; // <- confira a aba
const CODE = "HAB5D";
const PORTAL_URL = "https://integradaneuropsicologia.github.io/formularios/";
const RELEASE_KEYS = ["IAHSD"]; // coluna de liberação no Patients (valor "sim")

/* ===== HELPERS ===== */
const $ = s => document.querySelector(s);
const onlyDigits = s => (s||"").replace(/\D+/g,"");
const qs = k => new URLSearchParams(location.search).get(k) || "";
function setBox(id, text, kind="ok"){ const el=$(id); if(!el) return; el.textContent = text; el.className = "msg " + (kind==="ok"?"okbox":kind==="warn"?"warnbox":"errbox"); el.style.display = "block"; }
function hideBox(id){ const el=$(id); if(el){ el.style.display="none"; el.textContent=""; } }
function maskCPF(cpf){ const d = onlyDigits(cpf||""); if(d.length!==11) return cpf||""; return `${d.slice(0,3)}.${d.slice(3,6)}.${d.slice(6,9)}-${d.slice(9)}`; }
function fmtDateISO(iso){ if(!iso) return ""; const [y,m,d] = String(iso).split("-"); if(!y||!m||!d) return iso; return `${d}/${m}/${y}`; }
async function GET(url){ const r=await fetch(url); if(!r.ok) throw new Error("HTTP "+r.status); return r.json(); }
async function sheetSearch(sheet, params){ const usp = new URLSearchParams(params); return GET(`${SHEETDB_BASE}/search?sheet=${encodeURIComponent(sheet)}&${usp.toString()}`); }
async function sheetCreate(sheet, row){ const r = await fetch(`${SHEETDB_BASE}?sheet=${encodeURIComponent(sheet)}`, { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify({ data:[row] }) }); if(!r.ok) throw new Error(await r.text()); return r.json(); }
async function sheetPatchBy(sheet, column, value, data){ const r = await fetch(`${SHEETDB_BASE}/${encodeURIComponent(column)}/${encodeURIComponent(value)}?sheet=${encodeURIComponent(sheet)}`, { method:"PATCH", headers:{ "Content-Type":"application/json" }, body: JSON.stringify({ data }) }); if(!r.ok) throw new Error(await r.text()); return r.json(); }
const TOKEN = qs("token");
function goPortalWithToken(){
  try{
    const u = new URL(PORTAL_URL, location.href);
    if (TOKEN) u.searchParams.set("token", TOKEN);
    location.href = u.toString();
  }catch(_){
    const sep = PORTAL_URL.includes("?") ? "&" : "?";
    location.href = PORTAL_URL + (TOKEN ? sep + "token=" + encodeURIComponent(TOKEN) : "");
  }
}

/* ===== ITENS (50) ===== */
const D1 = [
  "Eu consigo entender conceitos complexos rapidamente.",
  "Eu gosto de desafios intelectuais que exigem raciocínio lógico.",
  "Eu tenho facilidade para resolver problemas que exigem pensamento crítico.",
  "Eu me interesso por tópicos que envolvem teorias e explicações abstratas.",
  "Eu costumo fazer conexões entre diferentes áreas do conhecimento.",
  "Eu me sinto confortável ao lidar com informações complexas.",
  "Eu costumo antecipar resultados ou prever consequências com facilidade.",
  "Eu gosto de resolver quebra-cabeças, jogos de lógica ou desafios matemáticos.",
  "Eu tenho facilidade para analisar e sintetizar informações.",
  "Eu costumo criar teorias ou explicações para entender fenômenos complexos."
];
const D2 = [
  "Eu consigo pensar em soluções criativas para problemas do dia a dia.",
  "Eu gosto de experimentar novas formas de realizar tarefas ou atividades.",
  "Eu crio projetos, desenhos ou textos que são diferentes e inovadores.",
  "Eu exploro várias maneiras de abordar um problema antes de escolher uma solução.",
  "Eu consigo combinar informações de diferentes fontes para criar algo novo.",
  "Eu gosto de participar de atividades que exigem pensamento criativo, como arte, escrita ou invenções.",
  "Eu demonstro flexibilidade cognitiva ao considerar diferentes pontos de vista.",
  "Eu sou capaz de improvisar e adaptar minhas ideias conforme novas informações surgem.",
  "Eu gosto de criar histórias, personagens ou cenários imaginários.",
  "Eu consigo ver novas utilidades para objetos comuns."
];
const D3 = [
  "Eu me sinto motivado(a) a alcançar meus objetivos, mesmo diante de dificuldades.",
  "Eu defino metas claras para meu desenvolvimento pessoal e profissional.",
  "Eu tenho disciplina para cumprir prazos e alcançar meus objetivos.",
  "Eu continuo trabalhando em uma tarefa até concluí-la, mesmo que enfrente obstáculos.",
  "Eu busco melhorar constantemente meu desempenho em várias áreas.",
  "Eu sou determinado(a) a alcançar metas de longo prazo.",
  "Eu me esforço para manter um alto padrão de qualidade em tudo o que faço.",
  "Eu tento superar meus próprios limites para alcançar resultados melhores.",
  "Eu me mantenho motivado(a) mesmo quando os resultados demoram a aparecer.",
  "Eu me sinto motivado(a) para alcançar resultados que sejam reconhecidos pelos outros."
];
const D4 = [
  "Eu me sinto confiante ao falar em público ou liderar grupos.",
  "Eu consigo motivar os outros a participarem e se engajarem em atividades.",
  "Eu demonstro empatia e sensibilidade ao interagir com os outros.",
  "Eu sou capaz de resolver conflitos de maneira justa e objetiva.",
  "Eu busco consenso nas tomadas de decisão e respeito opiniões diversas.",
  "Eu demonstro facilidade para liderar grupos e assumir responsabilidades.",
  "Eu sou capaz de delegar tarefas e organizar atividades com eficiência.",
  "Eu consigo influenciar as pessoas ao meu redor com minhas ideias.",
  "Eu sou visto(a) como uma pessoa confiável e justa por aqueles com quem convivo.",
  "Eu sou capaz de manter a harmonia em situações de conflito."
];
const D5 = [
  "Eu sou sensível às emoções das pessoas ao meu redor.",
  "Eu tenho facilidade para identificar meus próprios sentimentos e emoções.",
  "Eu percebo rapidamente mudanças de humor e comportamentos em outras pessoas.",
  "Eu busco compreender os motivos por trás dos sentimentos e comportamentos das pessoas.",
  "Eu costumo refletir profundamente sobre minhas emoções e reações.",
  "Eu busco entender o impacto de minhas ações sobre os outros.",
  "Eu demonstro sensibilidade a questões sociais e ambientais.",
  "Eu sou capaz de perceber quando uma pessoa está emocionalmente desconfortável.",
  "Eu me preocupo em manter um ambiente emocional saudável ao meu redor.",
  "Eu tenho consciência de minhas limitações e busco formas de superá-las."
];

const ITEMS = [...D1, ...D2, ...D3, ...D4, ...D5].map((t,i)=>({text:`${i+1}. ${t}`}));

/* ===== RENDER ===== */
function renderQuestions(){
  const host = $("#qs"); host.innerHTML = "";

  // cabeçalhos de seção
  const sections = [
    [1, "Dimensão 1 — Habilidades Cognitivas"],
    [11,"Dimensão 2 — Habilidades Criativas"],
    [21,"Dimensão 3 — Motivação e Determinação"],
    [31,"Dimensão 4 — Habilidades Sociais e de Liderança"],
    [41,"Dimensão 5 — Sensibilidade e Autoconsciência"],
  ];
  let nextSection = 0;

  ITEMS.forEach((it, idx)=>{
    const num = idx+1;
    if (nextSection < sections.length && num === sections[nextSection][0]){
      const div = document.createElement('div');
      div.className = 'section';
      div.textContent = sections[nextSection][1];
      host.appendChild(div);
      nextSection++;
    }

    const qn = String(num).padStart(2,"0");
    const row = document.createElement('div');
    row.className = 'item';
    row.setAttribute('data-q', String(num));

    const stem = document.createElement('div');
    stem.className = 'stem';
    stem.id = `s${qn}`;
    stem.textContent = it.text;

    const scale = document.createElement('div');
    scale.className = 'scale';

    const CHOICES = [
      {v:1, l:'Discordo Totalmente'}, {v:2, l:'Discordo'}, {v:3, l:'Nem Discordo e Nem concordo'}, {v:4, l:'Concordo'}, {v:5, l:'Concordo Totalmente'}
    ];
    CHOICES.forEach(c=>{
      const lab = document.createElement('label'); lab.className = 'opt'; lab.setAttribute('title', `${c.l} (${c.v})`);
      const id = `q${qn}_${c.v}`;
      lab.innerHTML = `<input type="radio" name="q${qn}" id="${id}" value="${c.v}" required aria-labelledby="s${qn}">
                       <span>${c.l}</span><small></small>`;
      scale.appendChild(lab);
    });

    row.append(stem, scale);
    host.appendChild(row);
  });
}

/* ===== ESTADO ===== */
let patient=null, tokenRow=null, CPF="";
const STORAGE_KEY = `HAB5D_${TOKEN||'anon'}`;

/* ===== BOOT ===== */
(async function boot(){
  try{
    if(!TOKEN){ setBox("#alert","Link inválido (sem token). Solicite um novo link.","err"); return; }

    const trows = await sheetSearch(SHEETS.TOKENS, { token: TOKEN });
    if(!trows || !trows.length) throw new Error("Token inválido ou expirado.");
    tokenRow = trows[0];
    if(String(tokenRow.disabled||"não").toLowerCase()==="sim") throw new Error("Token desativado. Peça um novo link.");
    if(tokenRow.expires_at && new Date(tokenRow.expires_at) < new Date()) throw new Error("Token expirado. Peça um novo link.");
    CPF = onlyDigits(tokenRow.cpf||"");
    if(!CPF) throw new Error("Token sem CPF vinculado.");

    const prows = await sheetSearch(SHEETS.PATIENTS, { cpf: CPF });
    if(!prows || !prows.length) throw new Error("Paciente não encontrado.");
    patient = prows[0];

    const isAllowed = RELEASE_KEYS.some(k => String(patient[k]||"").trim().toLowerCase()==="sim");
    if(!isAllowed){ setBox("#alert","Este formulário não está liberado para você.","err"); return; }

    // Já respondeu?
    const doneKeys = RELEASE_KEYS.map(k => `${k}_FEITO`);
    const anyDoneFlag = doneKeys.some(k => String(patient[k]||"").trim().toLowerCase()==="sim");
    const already = await sheetSearch(SHEETS.SCORES, { cpf: CPF, code: CODE });
    if(anyDoneFlag || (already && already.length)){
      setBox("#alert","Você já respondeu este formulário. Voltando ao portal…","ok");
      setTimeout(goPortalWithToken, 1200); return;
    }

    // Render
    renderPatientInfo();
    renderQuestions();
    restoreDraft();
    updateProgress();

    $("#pacInfo").style.display = "grid";
    $("#form").style.display = "block";
    $("#progressWrap").style.display = "block";
    hideBox("#alert");

  }catch(err){
    console.error(err);
    setBox("#alert", err.message || "Falha ao abrir o formulário. Tente novamente mais tarde.", "err");
  }
})();

function renderPatientInfo(){
  const g = $("#pacInfo"); g.innerHTML="";
  const info = [
    ["Nome", patient.nome || "-"],
    ["CPF", maskCPF(patient.cpf)],
    ["Nascimento", fmtDateISO(patient.data_nascimento)],
    ["E-mail", patient.email || "-"],
    ["WhatsApp", patient.whatsapp || "-"]
  ];
  for(const [k,v] of info){
    const div = document.createElement("div");
    div.className = "info";
    div.innerHTML = `<b>${k}</b><div>${v||"-"}</div>`;
    g.appendChild(div);
  }
}

/* ===== RASCUNHO LOCAL ===== */
function saveDraft(){
  const data = {};
  for(let i=1;i<=ITEMS.length;i++){
    const qn = String(i).padStart(2,"0");
    const sel = document.querySelector(`input[name="q${qn}"]:checked`);
    if(sel) data[`q${qn}`] = Number(sel.value);
  }
  try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); }catch(e){ console.warn("Sem espaço para salvar rascunho"); }
}
function restoreDraft(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return;
    const data = JSON.parse(raw);
    for(const [k,v] of Object.entries(data||{})){
      const el = document.querySelector(`input[name="${k}"][value="${v}"]`);
      if(el){ el.checked = true; }
    }
  }catch(e){ /* ignore */ }
}
function clearDraft(){ try{ localStorage.removeItem(STORAGE_KEY); }catch(e){} }

function countAnswered(){ let c=0; for(let i=1;i<=ITEMS.length;i++){ const qn=String(i).padStart(2,'0'); if(document.querySelector(`input[name="q${qn}"]:checked`)) c++; } return c; }
function updateProgress(){ const answered = countAnswered(); const total = ITEMS.length; $("#progressText").textContent = `Progresso: ${answered}/${total}`; $("#bar").style.width = `${(answered/total)*100}%`; }

/* ===== EVENTOS DE UI ===== */
addEventListener('change', (e)=>{ if(e.target && e.target.matches('input[type="radio"][name^="q"]')){ saveDraft(); updateProgress(); } });
$("#btnSave").addEventListener('click', ()=>{ saveDraft(); setBox('#msg','Rascunho salvo neste dispositivo.','ok'); });
$("#clearDraft").addEventListener('click', ()=>{ clearDraft(); setBox('#msg','Rascunho apagado.','warn'); });

/* ===== SOMATÓRIOS ===== */
function sumRange(from, to){
  let s = 0;
  for(let i=from;i<=to;i++){
    const qn = String(i).padStart(2,'0');
    const sel = document.querySelector(`input[name="q${qn}"]:checked`);
    s += sel ? Number(sel.value) : 0;
  }
  return s;
}
function nivel(sum){
  if (sum >= 46) return "Habilidade Excelente";
  if (sum >= 36) return "Boa Habilidade";
  if (sum >= 26) return "Habilidade Moderada";
  return "Habilidade Baixa";
}

/* ===== SUBMIT ===== */
let sending=false;
$("#form").addEventListener("submit", async (e)=>{
  e.preventDefault(); if(sending) return; sending = true; hideBox("#msg");
  const btn = $("#btnSubmit"); const originalText = btn.textContent; btn.disabled = true; btn.textContent = "Enviando…";
  try{
    if(!patient) throw new Error("Sessão inválida. Recarregue o link.");

    // Validação: todas respondidas
    for(let i=1;i<=ITEMS.length;i++){
      const qn = String(i).padStart(2,'0');
      const sel = document.querySelector(`input[name="q${qn}"]:checked`);
      if(!sel){
        const row = document.querySelector(`.item[data-q="${i}"]`);
        if(row) row.scrollIntoView({behavior:'smooth', block:'center'});
        throw new Error(`Responda o item ${i}.`);
      }
    }

    // Dimensões
    const D1t = sumRange(1,10);
    const D2t = sumRange(11,20);
    const D3t = sumRange(21,30);
    const D4t = sumRange(31,40);
    const D5t = sumRange(41,50);
    const total = D1t + D2t + D3t + D4t + D5t;

    const categoria_csv = [
      ` Dimensão 1: Habilidades Cognitivas=${D1t}`, ` Dimensão 1: Habilidades Cognitivas		
=${nivel(D1t)}`,
      `Dimensão 2: Habilidades Criativas
=${D2t}`, `Dimensão 2: Habilidades Criativas
=${nivel(D2t)}`,
      `Dimensão 3: Motivação e Determinação		
=${D3t}`, `Dimensão 3: Motivação e Determinação		
=${nivel(D3t)}`,
      ` Dimensão 4: Habilidades Sociais e de Liderança		
=${D4t}`, ` Dimensão 4: Habilidades Sociais e de Liderança		
=${nivel(D4t)}`,
      ` Dimensão 5:  Sensibilidade e Autoconsciência		
=${D5t}`, ` Dimensão 5:  Sensibilidade e Autoconsciência		
=${nivel(D5t)}`
    ].join(',');

    await sheetCreate(SHEETS.SCORES, {
      result_id: `${patient.cpf}_${CODE}_${Date.now()}`,
      token: TOKEN,
      cpf: patient.cpf,
      code: CODE,
      source: "paciente",
      submitted_at: new Date().toISOString(),
      total: total,
      categoria: categoria_csv,
      metrics: "" // espaço para futuros detalhes
    });

    // Marca como feito
    const doneUpdates = {};
    RELEASE_KEYS.map(k=>`${k}_FEITO`).forEach(k=>{ if(k in patient) doneUpdates[k] = "sim"; });
    if(Object.keys(doneUpdates).length===0) doneUpdates[`${RELEASE_KEYS[0]}_FEITO`] = "sim";
    await sheetPatchBy(SHEETS.PATIENTS, "cpf", patient.cpf, doneUpdates);

    clearDraft();
    setBox("#msg","Formulário enviado. Voltando ao portal…","ok");
    setTimeout(goPortalWithToken, 1100);

  }catch(err){
    console.error(err);
    setBox("#msg", err.message || "Falha ao enviar. Tente novamente.", "err");
    sending = false; btn.disabled = false; btn.textContent = originalText;
  }
});
</script>
</body>
</html>

